---
phase: 04-interactive-visualizations
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified: [src/components/visualizations/InterestRateDiagram.tsx, src/components/visualizations/index.ts, src/app/modules/[slug]/page.tsx, src/data/module-visualizations.ts]
autonomous: true
---

<objective>
Create the Interest Rate diagram and integrate all visualizations into module pages.

Purpose: Build an interactive visualization showing how interest rates affect bond prices and present values. Then integrate all visualizations (money flow, banking process, interest rates) into the appropriate module pages.
Output: Complete visualization system integrated with module navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-interactive-visualizations/04-CONTEXT.md
@.planning/phases/04-interactive-visualizations/04-02-SUMMARY.md
@.planning/phases/04-interactive-visualizations/04-03-SUMMARY.md

@src/components/visualizations/index.ts
@src/app/modules/[slug]/page.tsx
@src/data/modules.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InterestRateDiagram component</name>
  <files>src/components/visualizations/InterestRateDiagram.tsx</files>
  <action>
Create an interactive diagram showing interest rates vs bond prices:

```typescript
'use client';

import { useState, useMemo } from 'react';
import { motion } from '@/lib/motion';
import { Slider, AnimatedValue } from './index';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui';
import { cn } from '@/lib/utils';

interface InterestRateDiagramProps {
  className?: string;
}

export function InterestRateDiagram({ className }: InterestRateDiagramProps) {
  const [interestRate, setInterestRate] = useState(5);
  const [faceValue, setFaceValue] = useState(1000);
  const [yearsToMaturity, setYearsToMaturity] = useState(5);
  const [couponRate, setCouponRate] = useState(5);

  // Calculate bond price using present value formula
  const calculations = useMemo(() => {
    const r = interestRate / 100;
    const coupon = faceValue * (couponRate / 100);

    // PV of coupon payments + PV of face value
    let pvCoupons = 0;
    for (let t = 1; t <= yearsToMaturity; t++) {
      pvCoupons += coupon / Math.pow(1 + r, t);
    }
    const pvFaceValue = faceValue / Math.pow(1 + r, yearsToMaturity);
    const bondPrice = pvCoupons + pvFaceValue;

    // Determine premium/discount
    const priceStatus =
      bondPrice > faceValue
        ? 'premium'
        : bondPrice < faceValue
          ? 'discount'
          : 'par';

    return {
      bondPrice,
      pvCoupons,
      pvFaceValue,
      coupon,
      priceStatus,
      percentChange: ((bondPrice - faceValue) / faceValue) * 100,
    };
  }, [interestRate, faceValue, yearsToMaturity, couponRate]);

  // Visual bar showing inverse relationship
  const maxPrice = faceValue * 1.5;
  const pricePercentage = (calculations.bondPrice / maxPrice) * 100;

  return (
    <Card variant="glass" className={cn('overflow-hidden', className)}>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <span>üìà</span>
          Interest Rates & Bond Prices
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Controls */}
        <div className="grid md:grid-cols-2 gap-6">
          <Slider
            label="Market Interest Rate"
            value={interestRate}
            onChange={setInterestRate}
            min={1}
            max={15}
            step={0.5}
            unit="%"
          />
          <Slider
            label="Bond Coupon Rate"
            value={couponRate}
            onChange={setCouponRate}
            min={1}
            max={15}
            step={0.5}
            unit="%"
          />
          <Slider
            label="Face Value"
            value={faceValue}
            onChange={setFaceValue}
            min={500}
            max={5000}
            step={100}
            formatValue={(v) => `$${v.toLocaleString()}`}
          />
          <Slider
            label="Years to Maturity"
            value={yearsToMaturity}
            onChange={setYearsToMaturity}
            min={1}
            max={30}
            step={1}
            unit=" years"
          />
        </div>

        {/* Main Visualization */}
        <div className="bg-surface-0 rounded-xl p-6">
          {/* Price Bar */}
          <div className="space-y-3">
            <div className="flex justify-between items-center">
              <span className="text-sm text-text-muted">Bond Price</span>
              <AnimatedValue
                value={calculations.bondPrice}
                prefix="$"
                decimals={2}
                size="lg"
                className={cn(
                  calculations.priceStatus === 'premium' && 'text-green-500',
                  calculations.priceStatus === 'discount' && 'text-red-500',
                  calculations.priceStatus === 'par' && 'text-text-primary'
                )}
              />
            </div>

            {/* Visual Bar */}
            <div className="relative h-8 bg-surface-2 rounded-full overflow-hidden">
              {/* Face value marker */}
              <div
                className="absolute top-0 bottom-0 w-0.5 bg-text-muted z-10"
                style={{ left: `${(faceValue / maxPrice) * 100}%` }}
              />
              <div
                className="absolute -bottom-6 text-xs text-text-muted transform -translate-x-1/2"
                style={{ left: `${(faceValue / maxPrice) * 100}%` }}
              >
                Par
              </div>

              {/* Price bar */}
              <motion.div
                className={cn(
                  'h-full rounded-full',
                  calculations.priceStatus === 'premium' && 'bg-green-500',
                  calculations.priceStatus === 'discount' && 'bg-red-500',
                  calculations.priceStatus === 'par' && 'bg-primary-500'
                )}
                initial={false}
                animate={{ width: `${Math.min(pricePercentage, 100)}%` }}
                transition={{ type: 'spring', stiffness: 100, damping: 20 }}
              />
            </div>
          </div>

          {/* Status Badge */}
          <motion.div
            key={calculations.priceStatus}
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            className={cn(
              'mt-8 inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium',
              calculations.priceStatus === 'premium' && 'bg-green-500/10 text-green-600',
              calculations.priceStatus === 'discount' && 'bg-red-500/10 text-red-600',
              calculations.priceStatus === 'par' && 'bg-primary-500/10 text-primary-600'
            )}
          >
            {calculations.priceStatus === 'premium' && '‚¨ÜÔ∏è Trading at Premium'}
            {calculations.priceStatus === 'discount' && '‚¨áÔ∏è Trading at Discount'}
            {calculations.priceStatus === 'par' && '‚û°Ô∏è Trading at Par'}
            <span className="font-mono">
              ({calculations.percentChange >= 0 ? '+' : ''}
              {calculations.percentChange.toFixed(1)}%)
            </span>
          </motion.div>
        </div>

        {/* Breakdown */}
        <div className="grid grid-cols-2 gap-4">
          <div className="bg-surface-0 p-4 rounded-lg">
            <div className="text-xs text-text-muted uppercase tracking-wider mb-1">
              PV of Coupons
            </div>
            <AnimatedValue
              value={calculations.pvCoupons}
              prefix="$"
              decimals={2}
              size="md"
            />
            <div className="text-xs text-text-muted mt-1">
              {yearsToMaturity} payments of ${calculations.coupon}/year
            </div>
          </div>
          <div className="bg-surface-0 p-4 rounded-lg">
            <div className="text-xs text-text-muted uppercase tracking-wider mb-1">
              PV of Face Value
            </div>
            <AnimatedValue
              value={calculations.pvFaceValue}
              prefix="$"
              decimals={2}
              size="md"
            />
            <div className="text-xs text-text-muted mt-1">
              ${faceValue} in {yearsToMaturity} years
            </div>
          </div>
        </div>

        {/* Key Insight */}
        <div className="text-sm text-text-secondary bg-surface-0 p-4 rounded-lg">
          <strong>Key Insight:</strong> When market rates ({interestRate}%) are{' '}
          {interestRate > couponRate ? 'higher' : interestRate < couponRate ? 'lower' : 'equal'}{' '}
          than the coupon rate ({couponRate}%), the bond trades at a{' '}
          <span className={cn(
            'font-semibold',
            calculations.priceStatus === 'premium' && 'text-green-500',
            calculations.priceStatus === 'discount' && 'text-red-500'
          )}>
            {calculations.priceStatus}
          </span>
          . This inverse relationship is fundamental to bond valuation.
        </div>
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>Diagram renders, sliders update bond price in real-time, inverse relationship visible</verify>
  <done>InterestRateDiagram with bond pricing visualization and present value breakdown.</done>
</task>

<task type="auto">
  <name>Task 2: Create module-visualization mapping</name>
  <files>src/data/module-visualizations.ts, src/components/visualizations/index.ts</files>
  <action>
Create a mapping file linking visualizations to modules:

```typescript
// src/data/module-visualizations.ts
import { ComponentType } from 'react';

// Mapping of module slugs to their visualizations
export const moduleVisualizations: Record<string, string[]> = {
  'money-financial-system': ['MoneyFlowDiagram'],
  'interest-rates-returns': ['InterestRateDiagram'],
  'risk-term-structure': [], // Will be added in future
  'banking-intermediation': ['BankingProcessDiagram'],
  'central-banking-fed': ['MoneyFlowDiagram'], // Reuse for Fed operations
  'money-supply-process': ['MoneyFlowDiagram', 'BankingProcessDiagram'],
  'monetary-policy': [], // Will be added in future
  'international-finance': [], // Will be added in future
};

// Get visualization names for a module
export function getModuleVisualizations(slug: string): string[] {
  return moduleVisualizations[slug] || [];
}
```

Update barrel export:

```typescript
// src/components/visualizations/index.ts
export { Slider } from './Slider';
export { AnimatedValue } from './AnimatedValue';
export { FlowArrow } from './FlowArrow';
export { Entity } from './Entity';
export { MoneyFlowDiagram } from './MoneyFlowDiagram';
export { BankingProcessDiagram } from './BankingProcessDiagram';
export { InterestRateDiagram } from './InterestRateDiagram';
```
  </action>
  <verify>Mapping file exports, all visualizations in barrel export</verify>
  <done>Module-visualization mapping and complete barrel export.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate visualizations into module pages</name>
  <files>src/app/modules/[slug]/page.tsx</files>
  <action>
Update the module page to show visualizations for that module:

```typescript
import { modules } from '@/data/modules';
import { getModuleVisualizations } from '@/data/module-visualizations';
import { notFound } from 'next/navigation';
import {
  Container,
  Section,
  Card,
  CardHeader,
  CardTitle,
  CardContent,
} from '@/components/ui';
import Link from 'next/link';
import { VisualizationSection } from './VisualizationSection';

// Generate static params for all modules (required for static export)
export function generateStaticParams() {
  return modules.map((module) => ({
    slug: module.slug,
  }));
}

// Generate metadata for each module
export async function generateMetadata({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const module = modules.find((m) => m.slug === slug);
  if (!module) return { title: 'Module Not Found' };

  return {
    title: `${module.title} | iMBA Money & Banking`,
    description: module.description,
  };
}

export default async function ModulePage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const module = modules.find((m) => m.slug === slug);

  if (!module) {
    notFound();
  }

  // Find adjacent modules for navigation
  const currentIndex = modules.findIndex((m) => m.id === module.id);
  const prevModule = currentIndex > 0 ? modules[currentIndex - 1] : null;
  const nextModule =
    currentIndex < modules.length - 1 ? modules[currentIndex + 1] : null;

  // Get visualizations for this module
  const visualizations = getModuleVisualizations(slug);

  return (
    <>
      {/* Module Header */}
      <Section
        spacing="md"
        className="bg-gradient-to-b from-surface-0 to-surface-1"
      >
        <Container>
          <Link
            href="/"
            className="inline-flex items-center gap-2 text-text-secondary hover:text-text-primary transition-colors mb-6"
          >
            <span>&larr;</span>
            <span>Back to modules</span>
          </Link>

          <div className="flex items-start gap-6">
            <span className="text-5xl">{module.icon}</span>
            <div>
              <span className="text-sm font-medium text-text-muted uppercase tracking-wider">
                Module {module.id} of {modules.length}
              </span>
              <h1 className="text-3xl md:text-4xl font-bold text-text-primary mt-1">
                {module.title}
              </h1>
              <p className="text-lg text-text-secondary mt-2 max-w-2xl">
                {module.description}
              </p>
            </div>
          </div>
        </Container>
      </Section>

      {/* Visualizations Section */}
      {visualizations.length > 0 && (
        <Section spacing="lg">
          <Container>
            <h2 className="text-2xl font-bold text-text-primary mb-6">
              Interactive Visualizations
            </h2>
            <VisualizationSection visualizations={visualizations} />
          </Container>
        </Section>
      )}

      {/* Other Content Sections */}
      <Section spacing="lg">
        <Container>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {visualizations.length === 0 && (
              <Card variant="default">
                <CardHeader>
                  <CardTitle className="text-lg">üìä Visualizations</CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="text-text-secondary text-sm">
                    Interactive diagrams coming soon for this module.
                  </p>
                </CardContent>
              </Card>
            )}

            <Card variant="default">
              <CardHeader>
                <CardTitle className="text-lg">üßÆ Calculators</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-text-secondary text-sm">
                  Financial calculators will appear here in Phase 5.
                </p>
              </CardContent>
            </Card>

            <Card variant="default">
              <CardHeader>
                <CardTitle className="text-lg">üìù Quizzes & Flashcards</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-text-secondary text-sm">
                  Learning tools will appear here in Phase 6.
                </p>
              </CardContent>
            </Card>
          </div>
        </Container>
      </Section>

      {/* Module Navigation */}
      <Section spacing="md" className="border-t border-surface-2">
        <Container>
          <div className="flex justify-between items-center">
            {prevModule ? (
              <Link
                href={`/modules/${prevModule.slug}`}
                className="flex items-center gap-2 text-text-secondary hover:text-primary-500 transition-colors"
              >
                <span>&larr;</span>
                <div className="text-left">
                  <span className="text-xs text-text-muted block">
                    Previous
                  </span>
                  <span className="font-medium">{prevModule.title}</span>
                </div>
              </Link>
            ) : (
              <div />
            )}

            {nextModule ? (
              <Link
                href={`/modules/${nextModule.slug}`}
                className="flex items-center gap-2 text-text-secondary hover:text-primary-500 transition-colors"
              >
                <div className="text-right">
                  <span className="text-xs text-text-muted block">Next</span>
                  <span className="font-medium">{nextModule.title}</span>
                </div>
                <span>&rarr;</span>
              </Link>
            ) : (
              <div />
            )}
          </div>
        </Container>
      </Section>
    </>
  );
}
```

Create VisualizationSection client component:

```typescript
// src/app/modules/[slug]/VisualizationSection.tsx
'use client';

import {
  MoneyFlowDiagram,
  BankingProcessDiagram,
  InterestRateDiagram,
} from '@/components/visualizations';

const VISUALIZATION_MAP: Record<string, React.ComponentType<{ className?: string }>> = {
  MoneyFlowDiagram,
  BankingProcessDiagram,
  InterestRateDiagram,
};

interface VisualizationSectionProps {
  visualizations: string[];
}

export function VisualizationSection({ visualizations }: VisualizationSectionProps) {
  return (
    <div className="space-y-8">
      {visualizations.map((name) => {
        const Component = VISUALIZATION_MAP[name];
        if (!Component) return null;
        return <Component key={name} />;
      })}
    </div>
  );
}
```
  </action>
  <verify>Module pages show appropriate visualizations, /modules/money-financial-system shows MoneyFlowDiagram</verify>
  <done>Visualizations integrated into module pages based on module-visualization mapping.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] `npm run build` succeeds
- [ ] InterestRateDiagram renders with all 4 sliders
- [ ] Bond price updates in real-time with interest rate changes
- [ ] /modules/money-financial-system shows MoneyFlowDiagram
- [ ] /modules/interest-rates-returns shows InterestRateDiagram
- [ ] /modules/banking-intermediation shows BankingProcessDiagram
- [ ] Modules without visualizations show placeholder
</verification>

<success_criteria>
- All tasks completed
- Three core visualizations built (money flow, banking process, interest rates)
- Visualizations integrated into appropriate module pages
- All three CONTEXT.md essentials achieved:
  - Instant feedback (sliders update immediately)
  - Clear cause-effect (visual changes tied to inputs)
  - Visual simplicity (clean design, progressive complexity)
</success_criteria>

<output>
After completion, create `.planning/phases/04-interactive-visualizations/04-04-SUMMARY.md`
</output>
